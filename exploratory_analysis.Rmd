---
title: "Incarceration Exploratory Analysis"
author: "Ben Aoki-Sherwood"
date: "2023-01-26"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, message = FALSE}
# library for downloading Census variables
library(tidycensus)

#for formatting data
library(tidyverse)
library(maditr)
library(patchwork)
```

# Load and clean data

```{r}
# load incarceration data
incarc_data <- read.csv("https://github.com/vera-institute/incarceration-trends/raw/master/incarceration_trends.csv")
incarc_cols <- c("county_name", "total_jail_pop_rate", "aapi_jail_pop_rate", 
                 "black_jail_pop_rate", "latinx_jail_pop_rate", 
                 "native_jail_pop_rate", "white_jail_pop_rate",
                 "total_pop_15to64", "aapi_pop_15to64", "black_pop_15to64",
                 "latinx_pop_15to64", "native_pop_15to64", "white_pop_15to64",
                 "urbanicity")

# filter incarceration data to include only TX, 2018
# prepare county_name field as key for joining
tx_incarc <- incarc_data %>%
  filter(state == "TX" & year == 2018) %>%
  mutate(county_name = paste(county_name, ", Texas", sep = "")) %>%
  select(incarc_cols)
```

## Questions/Notes:

- Do we want median HOUSEHOLD (B19013) or median FAMILY (B19113) incomes?
- Per capita income is B19301
- Gini Index (inequality) is B19083

```{r}
# download ACS census data for Texas from 2018

# choose variables on Gini index (income inequality) and median household income by race
variables <- c("B19083_001E", "B19013_001E", "B19013A_001E", "B19013B_001E", 
               "B19013C_001E", "B19013D_001E", "B19013E_001E", "B19013F_001E", 
               "B19013G_001E", "B19013H_001E", "B19013I_001E")

tx_census <- get_acs(geography = "county", 
                     variables = variables, 
                     year = 2018,
                     state = "TX",
                     geometry = F)

code_book <- rbind(c("B19083_001", "gini_index"),
                   c("B19013_001", "household_income_all"),
                   c("B19013A_001", "household_income_white"),
                   c("B19013B_001", "household_income_black"),
                   c("B19013C_001", "household_income_native"),
                   c("B19013D_001", "household_income_asian"),
                   c("B19013E_001", "household_income_nhpi"),
                   c("B19013F_001", "household_income_other"),
                   c("B19013G_001", "household_income_two_races"),
                   c("B19013H_001", "household_income_white_not_hispanic"),
                   c("B19013I_001", "household_income_hispanic"))

#join to the Census data
code_book <- as.data.frame(code_book)
colnames(code_book) <- c("variable", "var_name")
tx_census <- left_join(tx_census, code_book)

#format the data so there is a row for each census tract and column for every variable
tx_acs_data <- maditr::dcast(tx_census, NAME ~ var_name, 
                               value.var = "estimate", 
                               fun.aggregate = NULL) %>%
  rename("county_name" = "NAME")
```

```{r}
# pivot data so we have (county, race) observations
# acs data:

long_acs <- tx_acs_data %>%
  select(-c("household_income_white", "household_income_other", 
            "household_income_two_races", "household_income_nhpi")) %>%
  pivot_longer(cols = c("household_income_all", "household_income_white_not_hispanic", 
                        "household_income_black",  "household_income_native", 
                        "household_income_asian", "household_income_hispanic"), 
               names_to = "race", 
               values_to = "median_household_income", 
               names_prefix = "household_income_") %>%
  mutate(race = str_replace(race, "_not_hispanic", ""), 
         race = str_replace(race, "hispanic", "latinx"))

# incarceration data:

long_incarc <- tx_incarc %>%
  rename_with(function (x) {str_replace(x, "_jail", ".jail")}) %>%
  rename_with(function (x) {str_replace(x, "_pop_15", ".pop_15")}) %>%
  pivot_longer(cols = c("total.jail_pop_rate", "aapi.jail_pop_rate", 
                        "black.jail_pop_rate", "latinx.jail_pop_rate", 
                        "native.jail_pop_rate", "white.jail_pop_rate",
                        "total.pop_15to64", "aapi.pop_15to64", "black.pop_15to64",
                        "latinx.pop_15to64", "native.pop_15to64", "white.pop_15to64"),
               names_to = c("race", ".value"), names_sep = "\\.") %>%
  mutate(race = str_replace(race, "aapi", "asian"),
         race = str_replace(race, "total", "all"))
```

```{r}
# join incarceration and census data, set 0s in incarceration data to NAs and remove NAs
joined_data <- left_join(long_acs, long_incarc, by = c("county_name", "race"))

# outlier in median household income is >1 order of magnitude smaller than all other points:
joined_data <- filter(joined_data, county_name != "Erath County, Texas" | race != "black")
joined_data_no_na <- joined_data %>% 
  mutate(jail_pop_rate = ifelse(jail_pop_rate == 0.0, NA, jail_pop_rate)) %>%
  drop_na()
```

# EDA

### controls

```{r}
# check relationship of controls (population, urbanicity) with jail rate
pop <- joined_data_no_na %>% ggplot(aes(x = log(pop_15to64), y = log(jail_pop_rate))) + geom_point()
urb <- joined_data_no_na %>% ggplot(aes(x = urbanicity, y = log(jail_pop_rate))) + geom_boxplot()
gini <- joined_data_no_na %>% ggplot(aes(x = gini_index, y = log(jail_pop_rate))) + geom_point()
inc <- joined_data_no_na %>% ggplot(aes(x = log(median_household_income), y = log(jail_pop_rate))) + geom_point()
(pop + urb) / (gini + inc)
```

```{r}
# check relationship of controls (population, urbanicity) with jail rate
pop <- joined_data %>% ggplot(aes(x = log(pop_15to64), y = log(jail_pop_rate))) + geom_point()
urb <- joined_data %>% ggplot(aes(x = urbanicity, y = log(jail_pop_rate))) + geom_boxplot()
gini <- joined_data %>% ggplot(aes(x = gini_index, y = log(jail_pop_rate))) + geom_point()
inc <- joined_data %>% ggplot(aes(x = log(median_household_income), y = log(jail_pop_rate))) + geom_point()
(pop + urb) / (gini + inc)
```

```{r}
joined_data %>%
  filter(race == "all") %>%
  ggplot(aes(x = log(pop_15to64), y = log(jail_pop_rate))) +
    geom_point()
```


### race and race*income

```{r}
# clear discrepancies between jail pop rates 
joined_data %>% 
  ggplot(aes(x = race, y = log1p(jail_pop_rate))) +
  geom_boxplot() +
  facet_grid(cols = vars(urbanicity))
```


```{r}
# see if effect of household_income differs by race
joined_data_no_na %>% 
  ggplot(aes(x = median_household_income, y = log(jail_pop_rate), color = race)) +
    geom_point() +
    geom_smooth(method = "lm", se = F)
```

